# サーバ構成のテンプレート化

仕事では CentOS 6, 7系のVPSを使うことが多いため、ここでは CentOS 7 を基本としてテンプレートを作成している

## 共通セキュリティ設定

参考: [そこそこセキュアなlinuxサーバーを作る](https://qiita.com/cocuh/items/e7c305ccffb6841d109c)

とりあえず行わなければならない基本的なセキュリティ設定は以下の通り

1. **services**（サービス関連）
    - **不要なサービスの停止**
        - 使われていないサービスが動いていると、管理コストが高くなり、想定外の動作が起こる可能性もあるため極力停止する
            - 参考: [Linuxで止めるべきサービスと止めないサービスの一覧](https://tech-mmmm.blogspot.com/2016/03/linux.html)
    - **SELinuxの無効化**
        - CentOS 7 など、モダンなOSでは、SELinuxという、Linuxのカーネルに強制アクセス制御 (MAC) 機能を付加するモジュールが有効化されている  
            - SELinuxは確かに有用だが、sshdのポート変更をする手順が煩雑化するなど、管理コストが高くなることも多い
            - そのため、今回は不要なサービスとして、SELinuxを無効化することにする
2. **sshd**（SSH接続関連）
    - **ポート変更**
        - SSHのデフォルト接続ポート25番は一般に知れ渡っており標的の対象となりやすいため、別のポートに変更する
    - **rootログイン不可**
        - rootはすべてのサーバにあるユーザであるため総当り攻撃される危険性がある
        - root権限はサーバ内のあらゆる操作が可能であるため乗っ取られると非常に危険
    - **パスワード認証不可**
        - パスワード認証は総当り攻撃の対象になるため禁止する（公開鍵認証のみ許可とする）
    - **SSH接続できないユーザの作成**
        - Web制作をしていると、デザイナやコーダーなどがFTP（SFTP）でファイルアップロードしたいという要望がある
        - そのような場合のために、SSH接続不可でSFTP接続のみ可能なユーザを作成しておくと便利
            - 参考: [sshで接続したくないけどSFTPは使いたい時の設定](https://qiita.com/nisihunabasi/items/aa0cf18dbf8fd4320b2c)
    - **sshdプロトコルの設定**
        - sshdプロトコル1には脆弱性があるらしいので、2に設定する（最近のディストリビューションは最初から設定されているが念の為）
    - **認証猶予時間と試行回数の制限**
        - 制限をきつくすると締め出されてしまう危険性もあるが、緩めに制限しておくと多少安心
3. **iptables**（ファイウォール関連）
    - **外部公開ポートの制限**
        - 外部に公開されているポートが多いと、それだけ攻撃を受けやすくなる
        - そのため、最低限外部接続可能なポート（httpポート, httpsポート, ssl（sftp）ポートを想定）以外のポートを閉じておく
            - 参考: [ファイアウォールiptablesを簡単解説](https://knowledge.sakura.ad.jp/4048/)
    - **ポートスキャン対策**
        - ポートスキャンとは、どのポートが開いているか外部から調査する攻撃手法

### ディレクトリ構成
ディレクトリ構成は、Ansibleのベストラクティスを参考にしつつ以下のような構成とした

参考: [Best Practice - Ansible Documentation](https://docs.ansible.com/ansible/latest/user_guide/playbooks_best_practices.html)

なお、共通セキュリティ設定関連は、**management**グループとしてまとめることとした

```bash
./
|_ production.yml # 本番サーバ用インベントリファイル
|_ main.yml # メインPlaybook｜playbooks/***.yml を読み込んで実行
|_ group_vars/ # 変数定義ファイル格納ディレクトリ
|   |_ all.yml # 全グループ共通の変数定義ファイル
|   |_ management/ # 共通セキュリティ設定関連の変数定義ファイルの格納ディレクトリ
|       :          ## Playbook名（グループ名）と統一する
|
|_ playbooks/ # 実際にサーバに対する操作を行うファイルを格納するディレクトリ｜インフラ管理者以外は触らない想定
    |_ management.yml # 共通セキュリティ設定を行うPlaybook｜roles/management/tasks/main.yml のタスクを実行
    |_ roles/ # Playbookで実行されるタスクを役割ごとに格納するディレクトリ
        |_ management/ # このディレクトリ名（role）は親Playbookの名前と揃える
            |_ tasks/  # 共通セキュリティ設定で実行するタスクを格納するディレクトリ
            |   |_ main.yml # 共通セキュリティ設定で実行されるメインタスク定義ファイル
            |   :
            |
            |_ templates/ # 設定ファイル等のテンプレート格納ディレクトリ
                :
```

運用方法にもよるが、基本的にグループ名とPlaybook名、Role名は統一したほうが分かりやすい

今回の場合、以下の名前はすべて `management` で統一する

- インベントリファイルに記述するグループ名
- `group_vars`ディレクトリ配下の、グループ内変数ファイル格納ディレクトリ名
- `playbooks`ディレクトリ配下の、実行Playbookファイル名
- `playbooks/roles`ディレクトリ配下の、実行タスク格納ディレクトリ名（Role名）

### SELinuxの無効化
まずは不要なサービスを無効化する

本来は、有効化されているサービスを一つ一つ調べて、不要なサービスを精査していく必要があるが、今回はSELinux機能の無効化のみ行う

Read [selinux.md](./selinux.md).

### ユーザ管理とsshd設定（＋iptables 設定）
続いて、運用に工夫が必要なsshd設定とユーザ管理を設定する

sshd設定は、iptables設定と一緒に対応してしまった方が安全であるため、iptablesによるアクセス制限（Firewall）の設定も行う

Read [users.md](./users.md).

***

## LAMP環境の構築

ここからは、システム開発の環境やサーバ要件等により構成は変わってくるが、ここでは以下のようなLAMP環境の構築を行う

- Apache: 2.4.41
    - 2.4.41 より前のバージョンには以下のような脆弱性が報告されている
        - クロスサイトスクリプティングの脆弱性（CVE-2019-10092）
        - メモリ破壊の脆弱性（CVE-2019-10081）
        - 潜在的なオープンリダイレクトの脆弱性（CVE-2019-10098）など
- PHP: 7.3.12
    - 執筆時点の最新推奨バージョン
    - FPMで使う場合ではあるが、7.3.11 以下の 7.3系のPHPにはリモートコード実行に関する脆弱性（CVE-2019-11043）がある
- MySQL: 5.7.28
    - MySQL 8系についてはまだ十分な知見が得られていないため、5.7系を選択

Read [lamp.md](./lamp.md).
